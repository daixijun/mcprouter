// API 密钥管理命令 - 基于配置文件存储

use crate::config::{ApiKeyRepository, ConfigError, McpServerRepository, Result};
use crate::error::{McpError, Result as McpResult};
use crate::types::{ApiKey, ApiKeyPermissions};
use tauri::Manager;

/// 从工具级别权限推导出授权的服务器列表
async fn get_allowed_servers_from_tools(
    app_handle: &tauri::AppHandle,
    api_key_id: &str,
    api_key_repo: &ApiKeyRepository,
) -> McpResult<Vec<String>, ConfigError> {
    let mcp_repo = McpServerRepository::new(app_handle).await?;

    // 获取授权的工具ID列表
    let tool_ids = api_key_repo.get_tools_by_api_key(api_key_id)?;

    // 收集工具所属的服务器名称
    let mut server_names = std::collections::HashSet::new();
    for tool_id in tool_ids {
        // 遍历所有服务器，查找包含此工具的服务器
        for server in mcp_repo.get_all() {
            if server.tools.iter().any(|t| t.id == tool_id) {
                server_names.insert(server.name.clone());
            }
        }
    }

    Ok(server_names.into_iter().collect())
}

#[tauri::command(rename_all = "snake_case")]
pub async fn create_api_key(
    app_handle: tauri::AppHandle,
    name: String,
    permissions: ApiKeyPermissions,
) -> Result<ApiKey> {
    let mut api_key_repo = ApiKeyRepository::new(&app_handle).await?;

    // 创建新的API密钥
    let (key, api_key_config) = api_key_repo.create(name.clone(), permissions.clone());

    // 添加工具权限
    for server_name in &permissions.allowed_servers {
        let mcp_repo = McpServerRepository::new(app_handle).await?;

        // 获取服务器的所有工具ID
        if let Some(server) = mcp_repo.get_by_name(server_name) {
            let tool_ids: Vec<String> = server.tools.iter().map(|t| t.id.clone()).collect();

            // 授权这些工具
            api_key_repo.grant_server_tools(&api_key_config.id, &tool_ids)?;
        }
    }

    // 保存配置
    api_key_repo.save()?;

    tracing::info!("Created new API key: {}", api_key_config.name);

    // 返回API密钥（仅在创建时显示明文密钥）
    Ok(ApiKey {
        id: api_key_config.id,
        name: api_key_config.name,
        key, // 实际密钥（仅在创建时显示）
        enabled: api_key_config.enabled,
        created_at: api_key_config.created_at.to_rfc3339(),
        permissions,
    })
}

#[tauri::command(rename_all = "snake_case")]
pub async fn list_api_keys(app_handle: tauri::AppHandle) -> Result<Vec<serde_json::Value>> {
    let api_key_repo = ApiKeyRepository::new(&app_handle).await?;

    // 获取API密钥列表（已隐藏敏感信息）
    let api_key_list = api_key_repo.get_all_list()?;

    // 转换为JSON格式
    let masked_keys: Vec<serde_json::Value> = api_key_list
        .into_iter()
        .map(|item| {
            serde_json::json!({
                "id": item.id,
                "name": item.name,
                "key": item.key,
                "enabled": item.enabled,
                "created_at": item.created_at.to_rfc3339(),
                "updated_at": item.updated_at.to_rfc3339(),
                "authorized_server_count": item.authorized_server_count,
                "authorized_tool_count": item.authorized_tool_count,
            })
        })
        .collect();

    Ok(masked_keys)
}

#[tauri::command(rename_all = "snake_case")]
pub async fn get_api_key_details(id: String) -> Result<ApiKey> {
    let app_handle = tauri::generate_handler_context!();
    let api_key_repo = ApiKeyRepository::new(app_handle).await?;

    // 获取API密钥详情
    let api_key = api_key_repo
        .get_by_id(&id)
        .ok_or_else(|| McpError::ConfigError(format!("API key not found: {}", id)))?;

    // 获取授权的工具ID列表
    let tool_ids = api_key_repo.get_tools_by_api_key(&id)?;

    // 通过工具权限推导出服务器名称列表
    let allowed_servers = get_allowed_servers_from_tools(app_handle, &id, &api_key_repo).await?;

    Ok(ApiKey {
        id: api_key.id.clone(),
        name: api_key.name.clone(),
        key: "***".to_string(), // 详情页不显示密钥
        enabled: api_key.enabled,
        created_at: api_key.created_at.to_rfc3339(),
        permissions: ApiKeyPermissions {
            allowed_servers,
            allowed_tools: tool_ids,
        },
    })
}

#[tauri::command(rename_all = "snake_case")]
pub async fn delete_api_key(id: String) -> Result<String> {
    let app_handle = tauri::generate_handler_context!();
    let mut api_key_repo = ApiKeyRepository::new(app_handle).await?;

    // 删除API密钥
    let deleted = api_key_repo.delete(&id)?;

    if !deleted {
        return Err(McpError::ConfigError(format!("API key not found: {}", id)));
    }

    // 保存更改
    api_key_repo.save()?;

    tracing::info!("Deleted API key: {}", id);
    Ok(format!("API key '{}' has been deleted", id))
}

#[tauri::command(rename_all = "snake_case")]
pub async fn toggle_api_key(id: String) -> Result<bool> {
    let app_handle = tauri::generate_handler_context!();
    let mut api_key_repo = ApiKeyRepository::new(app_handle).await?;

    // 切换启用状态
    let new_state = api_key_repo.toggle_enabled(&id)?;

    // 保存更改
    api_key_repo.save()?;

    tracing::info!(
        "Toggled API key '{}' to {}",
        id,
        if new_state { "enabled" } else { "disabled" }
    );
    Ok(new_state)
}

// 工具级权限管理命令

#[tauri::command(rename_all = "snake_case")]
pub async fn get_api_key_tools(api_key_id: String) -> Result<Vec<String>> {
    let app_handle = tauri::generate_handler_context!();
    let api_key_repo = ApiKeyRepository::new(app_handle).await?;

    let tool_ids = api_key_repo.get_tools_by_api_key(&api_key_id)?;
    Ok(tool_ids)
}

#[tauri::command(rename_all = "snake_case")]
pub async fn add_tool_permission(api_key_id: String, tool_id: String) -> Result<String> {
    let app_handle = tauri::generate_handler_context!();
    let mut api_key_repo = ApiKeyRepository::new(app_handle).await?;

    // 验证工具是否存在
    let mcp_repo = McpServerRepository::new(app_handle).await?;
    let tool_exists = mcp_repo
        .get_all()
        .iter()
        .any(|server| server.tools.iter().any(|t| t.id == tool_id));

    if !tool_exists {
        return Err(McpError::ConfigError(format!(
            "Tool not found: {}",
            tool_id
        )));
    }

    // 添加权限
    api_key_repo.add_tool_permission(&api_key_id, &tool_id)?;

    // 保存更改
    api_key_repo.save()?;

    tracing::info!("Added tool permission: {} -> {}", api_key_id, tool_id);
    Ok("Tool permission added".to_string())
}

#[tauri::command(rename_all = "snake_case")]
pub async fn remove_tool_permission(api_key_id: String, tool_id: String) -> Result<String> {
    let app_handle = tauri::generate_handler_context!();
    let mut api_key_repo = ApiKeyRepository::new(app_handle).await?;

    // 移除权限
    api_key_repo.remove_tool_permission(&api_key_id, &tool_id)?;

    // 保存更改
    api_key_repo.save()?;

    tracing::info!("Removed tool permission: {} -> {}", api_key_id, tool_id);
    Ok("Tool permission removed".to_string())
}

#[tauri::command(rename_all = "snake_case")]
pub async fn grant_server_tools_to_api_key(
    api_key_id: String,
    server_name: String,
) -> Result<String> {
    let app_handle = tauri::generate_handler_context!();
    let mut api_key_repo = ApiKeyRepository::new(app_handle).await?;

    // 获取服务器信息
    let mcp_repo = McpServerRepository::new(app_handle).await?;
    let server = mcp_repo
        .get_by_name(&server_name)
        .ok_or_else(|| McpError::ServiceNotFound(server_name.clone()))?;

    // 授权服务器的所有工具
    let tool_ids: Vec<String> = server.tools.iter().map(|t| t.id.clone()).collect();
    let granted_count = api_key_repo.grant_server_tools(&api_key_id, &tool_ids)?;

    // 保存更改
    api_key_repo.save()?;

    tracing::info!(
        "Granted {} tools from server {} to API key {}",
        granted_count,
        server_name,
        api_key_id
    );
    Ok(format!(
        "Granted {} tools from server '{}'",
        granted_count, server_name
    ))
}

#[tauri::command(rename_all = "snake_case")]
pub async fn revoke_server_tools_from_api_key(
    api_key_id: String,
    server_name: String,
) -> Result<String> {
    let app_handle = tauri::generate_handler_context!();
    let mut api_key_repo = ApiKeyRepository::new(app_handle).await?;

    // 获取服务器信息
    let mcp_repo = McpServerRepository::new(app_handle).await?;
    let server = mcp_repo
        .get_by_name(&server_name)
        .ok_or_else(|| McpError::ServiceNotFound(server_name.clone()))?;

    // 撤销服务器的所有工具权限
    let tool_ids: Vec<String> = server.tools.iter().map(|t| t.id.clone()).collect();
    let revoked_count = api_key_repo.revoke_server_tools(&api_key_id, &tool_ids)?;

    // 保存更改
    api_key_repo.save()?;

    tracing::info!(
        "Revoked {} tools from server {} for API key {}",
        revoked_count,
        server_name,
        api_key_id
    );
    Ok(format!(
        "Revoked {} tools from server '{}'",
        revoked_count, server_name
    ))
}
