# 实施任务清单：替换 rmcp 为 rust-mcp-sdk

## 1. 准备工作

### 1.1 研究 rust-mcp-sdk

- [ ] 1.1.1 调研 rust-mcp-sdk 的特性和 API
- [ ] 1.1.2 了解与 rmcp 的差异和兼容性
- [ ] 1.1.3 确定依赖版本和特性标志

### 1.2 分析现有代码

- [ ] 1.2.1 梳理 rmcp 的所有使用点
- [ ] 1.2.2 识别需要适配的接口
- [ ] 1.2.3 创建迁移映射表

### 1.3 设置测试环境

- [ ] 1.3.1 准备测试用的 MCP 服务器
- [ ] 1.3.2 创建测试用例
- [ ] 1.3.3 设置基准测试

## 2. 依赖更新

### 2.1 Cargo.toml 更新

- [ ] 2.1.1 移除 rmcp 依赖
- [ ] 2.1.2 添加 rust-mcp-sdk 依赖
- [ ] 2.1.3 配置必要的特性标志
- [ ] 2.1.4 运行 cargo update 确保依赖更新

## 3. HTTP 客户端模块移除（已完成）

### 3.1 决定移除 http_client.rs

- [x] 3.1.1 研究 rust-mcp-sdk 的 header 支持能力
- [x] 3.1.2 对比现有 HttpTransportConfig 功能与 rust-mcp-sdk 内置功能
- [x] 3.1.3 决定移除 http_client.rs（使用 rust-mcp-sdk 原生 API）
- [x] 3.1.4 制定迁移方案

### 3.2 执行移除

- [x] 3.2.1 移除 http_client.rs 文件
- [x] 3.2.2 清理 mcp_client.rs 中对该模块的引用
- [x] 3.2.3 直接使用 rust-mcp-sdk 的配置 API
- [x] 3.2.4 更新相关注释和文档

### 3.3 优势

- **代码简洁**：消除不必要的抽象层
- **更好性能**：减少一层调用开销
- **原生支持**：直接使用 rust-mcp-sdk 的所有特性
- **易于维护**：更少的代码意味着更少的潜在 bug

### 3.4 测试验证

- [ ] 3.4.1 验证基础配置构建
- [ ] 3.4.2 验证自定义 headers 传递
- [ ] 3.4.3 验证 Authorization header
- [ ] 3.4.4 运行单元测试

## 4. 客户端传输实现更新

### 4.1 STDIO 传输

- [ ] 4.1.1 更新 connect_stdio_service 函数
- [ ] 4.1.2 使用 rust-mcp-sdk 的 TokioChildProcess
- [ ] 4.1.3 更新 ClientInfo 和服务创建
- [ ] 4.1.4 验证工具列表和调用功能

### 4.2 SSE 传输

- [x] 4.2.1 更新 connect_sse_service 函数
- [x] 4.2.2 使用 rust-mcp-sdk 的 ClientSseTransport
- [x] 4.2.3 实现自定义 headers 支持（使用 ClientSseTransportOptions）
- [ ] 4.2.4 验证连接和工具列表功能

### 4.3 HTTP 传输

- [x] 4.3.1 更新 connect_http_service 函数
- [x] 4.3.2 直接使用 rust-mcp-sdk 的 ClientStreamableTransportOptions
- [x] 4.3.3 验证所有 headers 类型支持
- [ ] 4.3.4 验证流式传输功能

### 4.4 通用功能更新

- [ ] 4.4.1 更新 list_tools 函数
- [ ] 4.4.2 更新 disconnect_mcp_server 函数
- [ ] 4.4.3 更新 connection 状态管理
- [ ] 4.4.4 更新批量健康检查

## 5. 聚合服务器更新

### 5.1 导入更新

- [ ] 5.1.1 替换 rmcp 导入为 rust-mcp-sdk
- [ ] 5.1.2 更新 transport 导入
- [ ] 5.1.3 更新 model 导入
- [ ] 5.1.4 更新 service 导入

### 5.2 传输层更新

- [ ] 5.2.1 更新 SSE 客户端传输实现
- [ ] 5.2.2 更新 HTTP 客户端传输实现
- [ ] 5.2.3 验证认证和权限检查

### 5.3 服务器功能验证

- [ ] 5.3.1 验证工具路由
- [ ] 5.3.2 验证调用路由
- [ ] 5.3.3 验证权限控制
- [ ] 5.3.4 验证会话管理

## 6. 类型定义更新

### 6.1 类型适配

- [ ] 6.1.1 检查 McpTool 类型定义
- [ ] 6.1.2 更新其他相关类型
- [ ] 6.1.3 保持 serde 兼容性

### 6.2 编译检查

- [ ] 6.2.1 运行 cargo check
- [ ] 6.2.2 解决所有编译错误
- [ ] 6.2.3 验证类型安全

## 7. 集成测试

### 7.1 传输测试

- [ ] 7.1.1 测试 STDIO 传输连接
- [ ] 7.1.2 测试 SSE 传输连接（带 headers）
- [ ] 7.1.3 测试 HTTP 传输连接（带 headers）
- [ ] 7.1.4 测试多服务器并发连接

### 7.2 功能测试

- [ ] 7.2.1 测试工具列表获取
- [ ] 7.2.2 测试工具调用
- [ ] 7.2.3 测试错误处理
- [ ] 7.2.4 测试连接断开和重连

### 7.3 认证测试

- [ ] 7.3.1 测试 API Key 认证
- [ ] 7.3.2 测试 Bearer Token 认证
- [ ] 7.3.3 测试自定义 headers 认证
- [ ] 7.3.4 测试权限控制

## 8. 性能测试

### 8.1 基准测试

- [ ] 8.1.1 测试连接建立时间
- [ ] 8.1.2 测试工具调用延迟
- [ ] 8.1.3 测试并发连接性能
- [ ] 8.1.4 测试内存使用

### 8.2 压力测试

- [ ] 8.2.1 测试高并发连接
- [ ] 8.2.2 测试长时间运行稳定性
- [ ] 8.2.3 测试大量工具调用
- [ ] 8.2.4 测试网络异常恢复

## 9. 前端集成测试

### 9.1 API 兼容性

- [ ] 9.1.1 验证 Tauri 命令返回格式
- [ ] 9.1.2 验证前端类型定义
- [ ] 9.1.3 验证 UI 功能正常

### 9.2 端到端测试

- [ ] 9.2.1 测试完整用户流程
- [ ] 9.2.2 测试 MCP 服务器管理
- [ ] 9.2.3 测试工具使用
- [ ] 9.2.4 测试聚合接口访问

## 10. 文档和清理

### 10.1 代码清理

- [ ] 10.1.1 移除未使用的代码
- [ ] 10.1.2 添加必要注释
- [ ] 10.1.3 优化错误信息
- [x] 10.1.4 移除 http_client.rs 并清理相关引用
- [x] 10.1.5 更新模块结构（简化架构）

### 10.2 文档更新

- [ ] 10.2.1 更新 API 文档
- [ ] 10.2.2 更新迁移指南
- [ ] 10.2.3 更新配置说明

### 10.3 最终验证

- [ ] 10.3.1 运行完整测试套件
- [ ] 10.3.2 cargo clippy 检查
- [ ] 10.3.3 性能基准对比
- [ ] 10.3.4 最终代码审查

## 11. 部署准备

### 11.1 构建验证

- [ ] 11.1.1 debug 构建成功
- [ ] 11.1.2 release 构建成功
- [ ] 11.1.3 Tauri 应用打包成功

### 11.2 回滚计划

- [ ] 11.2.1 创建 rmcp 版本备份
- [ ] 11.2.2 准备回滚脚本
- [ ] 11.2.3 验证回滚流程

### 11.3 监控准备

- [ ] 11.3.1 设置日志监控
- [ ] 11.3.2 配置性能指标
- [ ] 11.3.3 准备错误报告模板
