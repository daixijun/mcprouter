## Context

此变更涉及两个核心改动：

1. 数据库表重命名（`tools` → `mcp_tools`）以符合命名规范
2. 授权粒度从 Server 级别细化到 Tool 级别

这是一个架构性变更，需要仔细处理数据迁移和向后兼容性。

## Goals / Non-Goals

**Goals**:

- 实现工具级别的精细化权限控制
- 保持数据库命名一致性（所有表使用 `mcp_` 前缀）
- 确保现有用户数据在升级时无损迁移
- 提供批量授权接口简化权限管理

**Non-Goals**:

- 不改变 MCP 协议本身的行为
- 不涉及 UI 层的权限配置界面（留待后续变更）
- 不处理角色（Role）或用户组（User Group）概念（当前仅支持 API Key）

## Decisions

### 决策 1: 新增关系表而非修改现有表

**选择**: 创建新的 `api_key_tool_relations` 表，保留 `api_key_server_relations` 表以支持迁移。

**理由**:

- 保留旧表可以在迁移脚本中读取历史数据
- 如果迁移失败，可以回滚到旧的授权系统
- 清晰地区分旧授权模型和新授权模型

**替代方案**:

- 直接修改 `api_key_server_relations` 表，添加 `tool_id` 字段：这会使数据模型混乱，难以表达"授权所有工具"的语义
- 完全删除旧表：风险较高，无法回滚

### 决策 2: 迁移策略 - Server 权限展开为所有 Tool 权限

**选择**: 对于每条 `api_key_server_relations` 记录，查询该 Server 下的所有工具，为每个工具创建一条 `api_key_tool_relations` 记录。

**理由**:

- 保持升级前后的权限语义一致（之前能访问 Server 的所有工具，升级后仍然能访问）
- 迁移后管理员可以手动收紧权限，移除不必要的工具授权

**风险**:

- 如果某个 Server 有大量工具（例如 100+ 个），会生成大量关系记录
- 缓解措施：在迁移脚本中添加批量插入优化，并在文档中说明

### 决策 3: 表重命名使用 SQLite 的 ALTER TABLE

**选择**: 使用 `ALTER TABLE tools RENAME TO mcp_tools`。

**理由**:

- SQLite 原生支持表重命名，操作原子性有保障
- 比创建新表 + 复制数据 + 删除旧表更安全高效

**注意事项**:

- 需要更新所有引用该表的索引、触发器（当前没有）

## Risks / Trade-offs

### 风险 1: 迁移失败导致权限丢失

**缓解措施**:

- 迁移脚本开始前备份 `api_key_server_relations` 表数据
- 使用事务包裹整个迁移过程，失败时回滚
- 添加详细的错误日志，方便排查问题

### 风险 2: 大量工具导致关系表膨胀

**影响**: 如果一个 Server 有 100 个工具，10 个 API Key，会产生 1000 条关系记录。

**缓解措施**:

- 在查询时使用索引优化性能（在 `api_key_id` 和 `tool_id` 上建立索引）
- 后续可考虑添加"授权策略"概念（例如：通配符规则）减少记录数

### Trade-off: 灵活性 vs 复杂度

**选择**: 提供工具级别的细粒度控制，但增加了管理复杂度。

**平衡点**:

- 提供批量授权接口 `grant_server_tools(api_key_id, server_id)` 简化操作
- UI 层可以提供"授权整个 Server"的快捷操作

## Migration Plan

### 升级流程

1. **检测阶段**: 应用启动时检测数据库版本（通过 schema_version 表或检查表是否存在）
2. **备份阶段**: 自动备份 `api_key_server_relations` 表数据到临时表
3. **迁移阶段**:
   - 执行 `ALTER TABLE tools RENAME TO mcp_tools`
   - 创建 `api_key_tool_relations` 表
   - 执行数据迁移逻辑（从 Server 权限展开为 Tool 权限）
4. **验证阶段**: 检查迁移后的权限数量是否合理（例如：新表记录数 ≈ 旧表记录数 × 平均工具数）
5. **清理阶段**: 保留 `api_key_server_relations` 表 7 天（可配置），方便回滚

### 回滚方案

如果迁移后发现问题：

1. 删除 `api_key_tool_relations` 表
2. 执行 `ALTER TABLE mcp_tools RENAME TO tools`
3. 从备份表恢复 `api_key_server_relations` 数据
4. 重启应用，回到旧版本授权逻辑

### 时间估算

- 迁移脚本执行时间：对于 < 1000 条 Server 权限记录，预计 < 5 秒
- 对于大型部署（10000+ 工具），可能需要 30-60 秒

## Open Questions

1. **是否需要在 UI 中显示迁移进度条？**

   - 如果迁移时间 > 10 秒，建议添加进度提示避免用户以为应用卡死

2. **`api_key_server_relations` 表何时彻底删除？**

   - 建议在下一个大版本（例如 v0.2.0）中删除，给用户足够的过渡期

3. **是否需要提供"撤销工具权限"的批量操作？**
   - 例如：管理员授权了 Server 的所有工具，后来想移除某个特定工具的权限
   - 可以在后续迭代中添加
